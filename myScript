#!/bin/bash

##
# alias
##

# git alias
alias ga="git add"
alias grhh="git reset --hard HEAD"
alias glog="git log --decorate --oneline --graph HEAD"
alias gpl="git pull"
alias gpu='git push --set-upstream $(git remote) $(git branch --show-current)'
alias gcmsg="git commit -m"
alias gcl="git clone"
alias gcom="git checkout master"
alias gcor="git checkout release"
alias gcod="git checkout develop"
alias gbnm="git checkout master && git checkout -b"
alias gd="git diff"

alias ls="eza"
alias mv="mv -i" # overwrite prompt
alias rm="rip"
alias cc="conda activate"
alias o="open"
alias c="init_yabai_env && command claude --permission-mode acceptEdits --dangerously-skip-permissions"
alias tc="T && init_yabai_env && claude --permission-mode acceptEdits --dangerously-skip-permissions"
alias co="init_yabai_env && command claude --permission-mode acceptEdits --model opus --dangerously-skip-permissions"
alias claude="init_yabai_env && claude --permission-mode acceptEdits --dangerously-skip-permissions"
alias copy="pbcopy"
alias nvi="nvim"
alias vim="nvim"
alias vi="nvim"
alias gs="git status -s"
alias gll="lazygit"
alias rr="ranger"
alias ll="ls -alh"
alias k="kubectl"
alias T="([ ! -e /tmp/T ] && mkdir /tmp/T); cd /tmp/T"
alias sch="screenshot-handler"
alias agf="ag -l -g"
alias tt="fzf --preview 'bat --style=numbers --color=always --line-range :500 {}'"
alias yabai-init="killall yabai; nohup yabai &> /dev/null &; killall sketchybar; nohup sketchybar &> /dev/null &;"
alias preview="open -a Preview"
alias dr="direnv allow"
alias curltime="curl -w \"@$HOME/.myjiaoben/curl/curltime.template\" -s "
alias grepi="grep --ignore-case"
alias tmux-init="rm ~/.tmux/resurrect/*; tm"

alias mcpp_convert_md_2_html="node ~/.myjiaoben/md-convert.js"

##
# path
##
export JAVA_HOME="/Library/Java/JavaVirtualMachines/zulu-8.jdk/Contents/Home"
export PATH=${PATH}:${JAVA_HOME}/bin

export GRADLE_USER_HOME="${HOME}/.m2/repository/"

export PATH=${PATH}:${HOME}/.cargo/bin
export PATH=${PATH}:${HOME}/.local/bin
export PATH=${PATH}:${HOME}/grampro/jmeter/bin

# GO config
export GO111MODULE="on"

# krew
export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"

# msf
export PATH="/opt/metasploit-framework/bin:$PATH"

# global config
# brew ç¦æ­¢è‡ªåŠ¨æ›´æ–°
export HOMEBREW_NO_AUTO_UPDATE=1
# kubectl
export KUBE_EDITOR="/opt/homebrew/bin/nvim"

# LS_COLOR
export LS_COLORS="$(vivid generate one-dark)"

# tmux
# æœ€å°ç¯å¢ƒå˜é‡å¯åŠ¨ï¼Œé˜²æ­¢ç¯å¢ƒå˜é‡æ±¡æŸ“
tmux() {
    env -i \
        HOME="$HOME" \
        TERM="${TERM:-xterm-256color}" \
        USER="$USER" \
        PATH="$PATH" \
        SHELL="$SHELL" \
        LANG="${LANG:-en_US.UTF-8}" \
        ${SSH_AUTH_SOCK:+SSH_AUTH_SOCK="$SSH_AUTH_SOCK"} \
        ${SSH_CONNECTION:+SSH_CONNECTION="$SSH_CONNECTION"} \
        command tmux "$@"
}

goto() {
	cd "$(dirname $1)"
}

# navi shortcuts
ch() {
  [[ $# -eq 0 ]] && navi || navi --query $*
}

# latest file
latest_file() {
  local targetFolder=${1:-$PWD}
  local fileName=$(ls -t $targetFolder | head -n 1)
  echo ${targetFolder%%/}/${fileName}
}

# mkdir and cd
take() {
  mkdir -p "$1" && cd "$1"
}

flush_dns() {
  sudo dscacheutil -flushcache;sudo killall -HUP mDNSResponder
}

fakeTimeWhen() {
  DYLD_FORCE_FLAT_NAMESPACE=1 DYLD_INSERT_LIBRARIES=/usr/local/lib/faketime/libfaketime.1.dylib FAKETIME=$1 ${@:2:100}
}

tscript() {
    # test script å¿«é€Ÿæµ‹è¯•è„šæœ¬
    # å½¢å¼: åœ¨ tmux ä¸­æ‰“å¼€å·¦å³ä¸¤ä¸ªçª—å£ï¼Œå·¦è¾¹æ˜¯è„šæœ¬ï¼Œå³è¾¹æ˜¯æµ‹è¯•ï¼Œè„šæœ¬ä¿®æ”¹åè‡ªåŠ¨æ‰§è¡Œ
    if ! command -v fswatch &> /dev/null; then
        echo -e "\033[32mfswatch\033[0m should be installed first."
        return
    fi

    local session_name
    local editor_pane
    local fswatch_pane

    if [ -z "$TMUX" ]; then
        # ä¸åœ¨ tmux é‡Œï¼šæ–°å»ºä¸€ä¸ª session
        session_name="tscript"
        tmux new-session -s "$session_name" -d
        # å–è¿™ä¸ª session é‡Œçš„ç¬¬ä¸€ä¸ª pane ä½œä¸ºç¼–è¾‘ pane
        editor_pane="$(tmux list-panes -t "$session_name" -F '#{pane_id}' | head -n1)"
    else
        # åœ¨ tmux é‡Œï¼šä½¿ç”¨å½“å‰ session & å½“å‰ pane
        session_name="$(tmux display-message -p '#S')"
        editor_pane="$(tmux display-message -p '#{pane_id}')"
    fi

    local script_file
    if [ -z "$1" ]; then
        script_file="/tmp/$(uuidgen).sh"
        pbpaste > "$script_file"
    else
        script_file="$1"
    fi

    # åœ¨ç¼–è¾‘ pane é‡Œæ‰“å¼€æ–‡ä»¶
    tmux send-keys -t "$editor_pane" "$EDITOR \"$script_file\"" C-m

    # ä»¥ç¼–è¾‘ pane ä¸ºç›®æ ‡æ°´å¹³åˆ†å±ï¼Œæ‹¿åˆ°æ–° pane çš„ id ä½œä¸º fswatch pane
    fswatch_pane="$(tmux split-window -h -t "$editor_pane" -P -F '#{pane_id}')"

    # åœ¨ fswatch pane é‡Œè·‘è‡ªåŠ¨æ‰§è¡Œè„šæœ¬
    tmux send-keys -t "$fswatch_pane" \
        "fswatch -o \"$script_file\" | xargs -n1 -I{} sh -c 'clear; echo \"=====================\"; echo \"\$(date +\"%Y-%m-%d %H:%M:%S\") ==> Running script\"; echo \"=====================\"; sh \"$script_file\"'" \
        C-m

    # å¦‚æœä¸€å¼€å§‹ä¸åœ¨ tmuxï¼Œå°± attach ä¸Šå»
    if [ -z "$TMUX" ]; then
        tmux attach -t "$session_name"
    fi
}

# å¿«é€Ÿåˆ‡æ¢ env æ–‡ä»¶
envuse() {
    ## Usage
    # envuse <environment>
    #
    # Eg: envuse dev
    #
    ##

    if [ -z "$1" ]; then
        echo "Usage: envuse <environment>"
        return
    fi
    local environment=$1

    # åˆ¤æ–­.env.${environment} æ˜¯å¦å­˜åœ¨
    if [ ! -f ".env.${environment}" ]; then
        echo "$(ansi --cyan .env.${environment}) not exist."
        return
    fi

    # åˆ¤æ–­ .env æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”æ˜¯æ–‡ä»¶
    if [[ -f ".env" && ! -L ".env" ]]; then
        echo "$(ansi --cyan .env) exists, and it's a file, please remove it first."
        return
    fi


    local env_file=".env.${environment}"
    ln -sf $env_file .env
}

# æœ¬åœ°ç«¯å£è½¬å‘
portforward() {
    if [[  $# -ne 3 ]]; then
        echo "Usage: portforward <source-port> <remote-port> <remote-ssh-server>"
        return
    fi

    echo "ssh -L ${1}:localhost:${2} ${3} -N"
    ssh -L ${1}:localhost:${2} ${3} -N
}

function pngpaste() {
    local name="${1}"

    [[ "$name" =~ '\.png$' ]] || name+=.png

    osascript -e "tell application \"System Events\" to Â¬
                  write (the clipboard as Â«class PNGfÂ») to Â¬
                          (make new file at folder \"$(pwd)\" with properties Â¬
                                  {name:\"${name}\"})"
}

function jpgpaste() {
    local name="${1}"
    ensure-args name @MRET
    ensure isDarwin @MRET


    [[ "$name" =~ '\.jpg$' ]] || name+=.jpg

    osascript -e "tell application \"System Events\" to Â¬
                  write (the clipboard as JPEG picture) to Â¬
                          (make new file at folder \"$(pwd)\" with properties Â¬
                                  {name:\"${name}\"})"
}

function zerotier-init() {
    sudo sysctl -w net.inet.ip.forwarding=1
    sudo pfctl -e -f /etc/pf.zerotier.conf
}

function concat_audio() {
  set -x
  local help() {
    echo "Usage: concat_audio <output> <audio1> <audio2> ..."
  }

  while getopts 'h' OPT; do
    case $OPT in
      h) help; return;;
    esac
  done

  local output=$1
  shift

  local files=()
  for file in "$@"; do
    abs_file=$(realpath "$file")
    files+=($abs_file)
    if [ ! -f "$abs_file" ]; then
      echo "File $abs_file not found"
      return 1
    fi
  done

  # mktemp -d | ffmpeg -f concat -safe 0 -i <(for f in "$@"; do echo "file '$f'"; done) -c copy "$output"
  local tmp_file=$(mktemp)
  for file in "${files[@]}"; do
    echo "file '$file'" >> $tmp_file
  done
  ffmpeg -f concat -safe 0 -i $tmp_file -c copy $output
  rm $tmp_file
}

adb_proxy() {
  # æ£€æŸ¥å½“å‰ä»£ç†é…ç½®
  CURRENT_PROXY=$(adb shell settings get global http_proxy)

  if [ -z "$CURRENT_PROXY" ] || [ "$CURRENT_PROXY" = ":0" ] || [ "$CURRENT_PROXY" = "null" ]; then
    # æœªè®¾ç½®ä»£ç†ï¼Œæ‰§è¡Œè®¾ç½®æ“ä½œ
    MY_IP=$(ipconfig getifaddr en0)
    PROXY_PORT=29091
    echo "æœªæ£€æµ‹åˆ°ä»£ç†é…ç½®ï¼Œæ­£åœ¨è®¾ç½®ä»£ç†..."
    echo "ç›®æ ‡ä»£ç†: ${MY_IP}:${PROXY_PORT}"
    adb shell settings put global http_proxy "${MY_IP}:${PROXY_PORT}"
    adb shell settings put global global_http_proxy_host "${MY_IP}"
    adb shell settings put global global_http_proxy_port "${PROXY_PORT}"
    echo "âœ“ ä»£ç†è®¾ç½®æˆåŠŸ: ${MY_IP}:${PROXY_PORT}"
  else
    # å·²è®¾ç½®ä»£ç†ï¼Œæ‰§è¡Œæ¸…é™¤æ“ä½œ
    echo "æ£€æµ‹åˆ°ç°æœ‰ä»£ç†é…ç½®: ${CURRENT_PROXY}"
    echo "æ­£åœ¨æ¸…é™¤ä»£ç†..."
    adb shell settings put global http_proxy :0
    adb shell settings delete global global_http_proxy_host
    adb shell settings delete global global_http_proxy_port
    adb shell settings delete global global_http_proxy_exclusion_list
    echo "âœ“ ä»£ç†å·²æ¸…é™¤"
  fi
}

function runin() {
  local dir=$1
  shift
  (cd "$dir" && "$@")
}

# è®¾ç½®ä»£ç†
function p() {
    local port=${1:-7890}
    export https_proxy=http://127.0.0.1:$port http_proxy=http://127.0.0.1:$port no_proxy=127.0.0.1,localhost,local,.local,10.10.0.0/16,192.168.60.245/16
    export HTTPS_PROXY=http://127.0.0.1:$port HTTP_PROXY=http://127.0.0.1:$port NO_PROXY=127.0.0.1,localhost,local,.local,10.10.0.0/16,192.168.60.245/16
}

# è®¾ç½® socks ä»£ç†
function psocks() {
    local port=${1:-7890}
    export https_proxy=socks5h://127.0.0.1:$port http_proxy=socks5h://127.0.0.1:$port no_proxy=127.0.0.1,localhost,local,.local,10.10.0.0/16,192.168.60.245/16
    export HTTPS_PROXY=socks5h://127.0.0.1:$port HTTP_PROXY=socks5h://127.0.0.1:$port NO_PROXY=127.0.0.1,localhost,local,.local,10.10.0.0/16,192.168.60.245/16
}

# æ¸…é™¤ä»£ç†
function rp() {
    export https_proxy= http_proxy= no_proxy=
    export HTTPS_PROXY= HTTP_PROXY= NO_PROXY=
}

# Claude Code Open - å¿«é€Ÿåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å½“å‰ session
function ccoo() {
    local SESSION_DIR="/tmp/claude-session-open"
    local BASE_URL="http://ccu.localhost/session"

    # æŸ¥æ‰¾å½“å‰ shell çš„ session ID
    local find_session_id() {
        local current_pid=$$
        local parent_pid=$PPID

        # å°è¯•å½“å‰ PID
        [[ -f "$SESSION_DIR/$current_pid" ]] && cat "$SESSION_DIR/$current_pid" && return 0

        # å°è¯•çˆ¶ PID
        [[ -f "$SESSION_DIR/$parent_pid" ]] && cat "$SESSION_DIR/$parent_pid" && return 0

        # å°è¯•ç¥–çˆ¶ PIDï¼ˆå¤„ç† tmux/screenï¼‰
        local grandparent_pid=$(ps -o ppid= -p $parent_pid | tr -d ' ')
        [[ -f "$SESSION_DIR/$grandparent_pid" ]] && cat "$SESSION_DIR/$grandparent_pid" && return 0

        # æœ€è¿‘ä¿®æ”¹çš„ session æ–‡ä»¶
        local latest_session=$(ls -t "$SESSION_DIR" 2>/dev/null | head -n 1)
        [[ -n "$latest_session" ]] && cat "$SESSION_DIR/$latest_session" && return 0

        return 1
    }

    local session_id=$(find_session_id)

    if [[ -z "$session_id" ]]; then
        echo "âŒ æœªæ‰¾åˆ° Claude Code session ID"
        echo "ğŸ’¡ è¯·ç¡®ä¿ï¼š"
        echo "   1. å·²åœ¨ Claude Code ä¸­è¿è¡Œæ­¤å‘½ä»¤"
        echo "   2. SessionStart hook å·²æ­£ç¡®é…ç½®"
        return 1
    fi

    local url="$BASE_URL/$session_id"
    echo "ğŸš€ æ­£åœ¨æ‰“å¼€ session: $session_id"
    echo "ğŸ”— URL: $url"

    open "$url"
}

function init_yabai_env() {
    if command -v yabai &> /dev/null; then
        export YABAI_SPACE_INDEX="$(yabai -m query --spaces --space | jq '.index')"
    fi
}

# æ™ºèƒ½è¿æ¥ tmuxï¼Œä½¿ç”¨å½“å‰æ–‡ä»¶å¤¹åä½œä¸º session å
function tf() {
  local session_name="$(basename "$PWD")"

  # æ£€æŸ¥ session æ˜¯å¦å­˜åœ¨
  if tmux has-session -t "$session_name" 2>/dev/null; then
      # å­˜åœ¨åˆ™åˆ›å»ºæ–°çš„å…³è”ä¼šè¯
      tmux new-session -t "$session_name"
  else
      # ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–° session
      tmux new-session -s "$session_name"
  fi
}

############### execute command #####################
# é»˜è®¤å¼€å¯ä»£ç†
p

############## è¦†ç›–ç§æœ‰é…ç½® #########################

[[ -f ${HOME}/.myScript.private.sh ]] && source ${HOME}/.myScript.private.sh
